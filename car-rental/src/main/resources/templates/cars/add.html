<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${carForm.id != null} ? 'Sửa thông tin xe' : 'Thêm xe mới'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        .current-image {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }
        .btn-group-action {
            display: flex;
            gap: 1rem;
        }
        .invalid-feedback {
            display: none;
        }
        .was-validated .invalid-feedback {
            display: block;
        }
        .form-control.is-required::after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
    <header th:replace="~{fragments/header :: header}"></header>

    <div class="container content-wrapper my-5">
        <h1 class="mb-4" th:text="${carForm.id != null} ? 'Sửa thông tin xe' : 'Thêm xe mới'"></h1>

        <!-- Thông báo lỗi chung -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Form thêm/sửa xe -->
        <form th:action="${carForm.id != null} ? @{/cars/edit/{id}(id=${carForm.id})} : @{/cars/add}"
              th:object="${carForm}"
              method="post"
              enctype="multipart/form-data"
              class="needs-validation"
              novalidate>

            <input type="hidden" th:field="*{id}"/>

            <div class="row g-3">
                <!-- Hãng xe -->
                <div class="col-md-6">
                    <label for="make" class="form-label">Hãng xe <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="make" th:field="*{make}" required>
                    <div class="invalid-feedback" th:errors="*{make}"></div>
                </div>

                <!-- Model -->
                <div class="col-md-6">
                    <label for="model" class="form-label">Model <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="model" th:field="*{model}" required>
                    <div class="invalid-feedback" th:errors="*{model}"></div>
                </div>

                <!-- Năm sản xuất -->
                <div class="col-md-6">
                    <label for="year" class="form-label">Năm sản xuất <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="year" th:field="*{year}" min="1980" max="2026" required>
                    <div class="invalid-feedback" th:errors="*{year}"></div>
                </div>

                <!-- Hộp số -->
                <div class="col-md-6">
                    <label for="transmission" class="form-label">Hộp số <span class="text-danger">*</span></label>
                    <select class="form-select" id="transmission" th:field="*{transmission}" required>
                        <option value="">Chọn hộp số</option>
                        <option value="MANUAL">Số sàn</option>
                        <option value="AUTO">Tự động</option>
                    </select>
                    <div class="invalid-feedback" th:errors="*{transmission}"></div>
                </div>

                <!-- Nhiên liệu -->
                <div class="col-md-6">
                    <label for="fuelType" class="form-label">Loại nhiên liệu <span class="text-danger">*</span></label>
                    <select class="form-select" id="fuelType" th:field="*{fuelType}" required>
                        <option value="">Chọn loại nhiên liệu</option>
                        <option value="GAS">Xăng</option>
                        <option value="DIESEL">Dầu</option>
                        <option value="ELECTRIC">Điện</option>
                        <option value="HYBRID">Hybrid</option>
                    </select>
                    <div class="invalid-feedback" th:errors="*{fuelType}"></div>
                </div>

                <!-- Số ghế -->
                <div class="col-md-6">
                    <label for="seats" class="form-label">Số ghế <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="seats" th:field="*{seats}" min="1" max="12" required>
                    <div class="invalid-feedback" th:errors="*{seats}"></div>
                </div>

                <!-- Giá thuê/ngày -->
                <div class="col-md-6">
                    <label for="dailyPrice" class="form-label">Giá thuê/ngày (VND) <span class="text-danger">*</span></label>
                    <input type="number" step="1000" class="form-control" id="dailyPrice" th:field="*{dailyPrice}" min="0" required>
                    <div class="invalid-feedback" th:errors="*{dailyPrice}"></div>
                </div>

                <!-- Thành phố -->
                <div class="col-md-6">
                    <label for="city" class="form-label">Thành phố <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="city" th:field="*{city}" required>
                    <div class="invalid-feedback" th:errors="*{city}"></div>
                </div>

                <!-- Biển số (bắt buộc) -->
                <div class="col-md-6">
                    <label for="plateMasked" class="form-label">Biển số <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="plateMasked" th:field="*{plateMasked}" required>
                    <div class="invalid-feedback" th:errors="*{plateMasked}"></div>
                </div>

                <!-- VIN (tùy chọn) -->
                <div class="col-md-6">
                    <label for="vinString" class="form-label">VIN (sẽ được mã hóa)</label>
                    <input type="text" class="form-control" id="vinString" th:field="*{vinString}" placeholder="VD: 1HGCM82633A123456">
                </div>

                <!-- Upload ảnh -->
                <div class="col-12">
                    <label for="imageFiles" class="form-label">
                        Ảnh xe <span class="text-danger">*</span>
                        <span th:if="${carForm.id == null}" class="text-muted small">(ít nhất 1 ảnh)</span>
                        <span th:if="${carForm.id != null}" class="text-muted small">(có thể bỏ qua nếu không thay đổi)</span>
                    </label>
                    <input type="file"
                           class="form-control"
                           id="imageFiles"
                           name="imageFiles"
                           accept="image/*"
                           multiple
                           th:required="${carForm.id == null}">
                    <small class="text-muted">Tối đa 5 ảnh. Mỗi ảnh ≤ 5MB.</small>
                    <div class="invalid-feedback">Vui lòng chọn ít nhất 1 ảnh khi thêm xe mới.</div>

                    <!-- Hiển thị ảnh hiện tại (khi sửa) -->
                    <div th:if="${carForm.existingImageUrls != null and not #lists.isEmpty(carForm.existingImageUrls)}" class="mt-3">
                        <p class="mb-2"><strong>Ảnh hiện tại:</strong></p>
                        <div class="row g-2">
                            <div th:each="url, iter : ${carForm.existingImageUrls}" class="col-4 col-md-3 col-lg-2">
                                <img th:src="${url}"
                                     alt="Ảnh xe hiện tại"
                                     class="img-thumbnail current-image w-100"/>
                            </div>
                        </div>
                        <small class="text-muted">Bạn có thể xóa ảnh cũ bằng cách tải ảnh mới (hệ thống sẽ thay thế).</small>
                    </div>
                </div>
            </div>

            <!-- Nút hành động -->
            <div class="btn-group-action justify-content-center mt-5">
                <button type="submit" class="btn btn-primary btn-lg px-5">
                    <span th:if="${carForm.id != null}">Cập nhật xe</span>
                    <span th:if="${carForm.id == null}">Thêm xe</span>
                </button>
                <a th:href="@{/cars/list}" class="btn btn-secondary btn-lg px-5">Quay lại</a>
            </div>
        </form>
    </div>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/script.js}"></script>

    <!-- JavaScript xử lý form -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        (function () {
            'use strict';

            // Giới hạn 5 ảnh
            const imageInput = document.getElementById('imageFiles');
            const existingCount = /*[[${carForm.existingImageUrls != null ? carForm.existingImageUrls.size() : 0}]]*/ 0;
            const isEditMode = /*[[${carForm.id != null}]]*/ false;

            imageInput.addEventListener('change', function () {
                const files = this.files;
                if (files.length + existingCount > 5) {
                    alert(`Tối đa 5 ảnh! Bạn đã có ${existingCount} ảnh cũ.`);
                    this.value = '';
                }
            });

            // Xử lý submit form
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', function (event) {
                    // Kiểm tra ảnh bắt buộc khi thêm mới
                    if (!isEditMode && imageInput.files.length === 0) {
                        imageInput.classList.add('is-invalid');
                        event.preventDefault();
                        event.stopPropagation();
                    } else {
                        imageInput.classList.remove('is-invalid');
                    }

                    // Kiểm tra HTML5 validation
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }

                    form.classList.add('was-validated');
                }, false);
            });
        })();
        /*]]>*/
    </script>
</body>
</html>