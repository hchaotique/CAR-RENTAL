<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Đơn Thuê Xe - Car Rental System</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .booking-status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-pending_host { background: #fef3c7; color: #d97706; }
        .status-instant_confirmed { background: #d1fae5; color: #059669; }
        .status-payment_authorized { background: #dbeafe; color: #2563eb; }
        .status-in_progress { background: #fef3c7; color: #d97706; }
        .status-completed { background: #d1fae5; color: #059669; }
        .status-cancelled_guest { background: #fee2e2; color: #dc2626; }
        .status-cancelled_host { background: #fee2e2; color: #dc2626; }

        .details-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 32px;
            margin-top: 32px;
        }

        .main-details {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .section {
            margin-bottom: 32px;
        }

        .section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #111;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 500;
            color: #111;
        }

        .car-info {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .car-image {
            width: 120px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }

        .car-details h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #111;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 24px;
            padding-left: 16px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6b7280;
        }

        .timeline-item.active::before {
            background: #10b981;
        }

        .timeline-item.completed::before {
            background: #10b981;
        }

        .timeline-item.pending::before {
            background: #f59e0b;
        }

        .timeline-item.cancelled::before {
            background: #ef4444;
        }

        .timeline-time {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .timeline-title {
            font-weight: 600;
            color: #111;
            margin-bottom: 4px;
        }

        .timeline-desc {
            font-size: 14px;
            color: #6b7280;
        }

        .charges-breakdown {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .charge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .charge-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 16px;
            color: #111;
        }

        .charge-label {
            color: #374151;
        }

        .charge-amount {
            font-weight: 500;
        }

        .charge-amount.positive {
            color: #059669;
        }

        .charge-amount.negative {
            color: #dc2626;
        }

        .actions-section {
            margin-top: 24px;
        }

        .btn-action {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 12px;
            margin-bottom: 8px;
        }

        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #5855eb; }

        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }

        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }

        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }

        .payout-info {
            background: #ecfdf5;
            border: 1px solid #d1fae5;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .payout-info h4 {
            margin: 0 0 8px 0;
            color: #065f46;
            font-size: 16px;
        }

        .payout-amount {
            font-size: 20px;
            font-weight: 600;
            color: #047857;
        }

        .contact-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .contact-info h4 {
            margin: 0 0 12px 0;
            color: #0c4a6e;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #374151;
        }

        .contact-item:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .details-container {
                grid-template-columns: 1fr;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .car-info {
                flex-direction: column;
                text-align: center;
            }

            .car-image {
                width: 100%;
                height: 120px;
            }

            .actions-section .btn-action {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a th:href="@{/}" style="text-decoration: none; color: inherit;">
                        <span class="logo-text">Car Rental Systerm</span>
                    </a>
                </div>
                <nav class="nav">
                    <a href="#" class="nav-link">Chi tiết đơn</a>
                </nav>
                <div class="header-actions">
                    <button class="menu-btn">
                        <i class="fas fa-bars"></i>
                    </button>

                    <div class="user-dropdown-container">
                        <button class="user-btn">
                            <span sec:authorize="isAuthenticated()" th:text="${#authentication.name}" class="username-display"></span>
                            <i class="fas fa-user-circle"></i>
                        </button>

                        <div class="user-dropdown-menu">
                            <div sec:authorize="isAuthenticated()">
                                <a th:href="@{/profile}">Hồ sơ của tôi</a>
                                <a th:href="@{/change-password}">Đổi mật khẩu</a>
                                <a th:href="@{/bookings/my-bookings}">Đơn của tôi</a>
                                <form th:action="@{/logout}" method="post" class="logout-form">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="logout-button-as-link">Đăng xuất</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="main-content">
        <div class="container">
            <div style="margin-bottom: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h1>Đơn #<span id="booking-id">Loading...</span></h1>
                    <span id="booking-status" class="booking-status">Loading...</span>
                </div>
                <p style="color: #6b7280;">Chi tiết đầy đủ đơn đặt xe</p>
            </div>

            <div id="loading-state" class="loading" style="display: block;">
                <div class="spinner"></div>
                <p>Đang tải dữ liệu...</p>
            </div>

            <div id="booking-content" style="display: none;">
                <div class="details-container">
                    <!-- Main Details -->
                    <div class="main-details">
                        <!-- Car Information -->
                        <div class="section">
                            <h3><i class="fas fa-car"></i> Thông Tin Xe</h3>
                            <div id="car-info" class="car-info">
                                <!-- Car info will be loaded here -->
                            </div>
                        </div>

                        <!-- Booking Details -->
                        <div class="section">
                            <h3><i class="fas fa-calendar"></i> Chi Tiết Đặt Xe</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Ngày bắt đầu</span>
                                    <span id="start-date" class="info-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ngày kết thúc</span>
                                    <span id="end-date" class="info-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Thời gian thuê</span>
                                    <span id="duration" class="info-value">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Địa điểm giao nhận</span>
                                    <span id="location" class="info-value">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div class="section">
                            <h3><i class="fas fa-history"></i> Tiến Trình Đơn</h3>
                            <div id="timeline" class="timeline">
                                <!-- Timeline will be loaded here -->
                            </div>
                        </div>

                        <!-- Charges Breakdown -->
                        <div class="section">
                            <h3><i class="fas fa-receipt"></i> Chi Tiết Thanh Toán</h3>
                            <div id="charges-breakdown" class="charges-breakdown">
                                <!-- Charges will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="sidebar">
                        <!-- Contact Information -->
                        <div class="section">
                            <h3><i class="fas fa-user"></i> Thông Tin Liên Hệ</h3>
                            <div id="contact-info" class="contact-info">
                                <!-- Contact info will be loaded here -->
                            </div>
                        </div>

                        <!-- Payout Information (for hosts) -->
                        <div id="payout-section" class="section" style="display: none;">
                            <h3><i class="fas fa-money-bill-wave"></i> Thanh Toán</h3>
                            <div id="payout-info" class="payout-info">
                                <!-- Payout info will be loaded here -->
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="section">
                            <h3><i class="fas fa-tasks"></i> Thao Tác</h3>
                            <div id="actions-section" class="actions-section">
                                <!-- Actions will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>©2025 Bonboncar</p>
                <div class="footer-links">
                    <a href="#">Điều khoản dịch vụ</a>
                    <a href="#">Chính sách bảo mật</a>
                </div>
            </div>
        </div>
    </footer>

    <script th:src="@{/js/script.js}"></script>
    <script>
        let bookingData = null;

        // Get booking ID from URL
        const bookingId = window.location.pathname.split('/').pop();

        // Load booking details on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadBookingDetails(bookingId);

            // Check for success message from flash attributes
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            if (success) {
                showToast('Thanh toán thành công! Đơn đặt xe của bạn đã được xử lý.', 'success');
            }
        });

        async function loadBookingDetails(id) {
            const loading = document.getElementById('loading-state');
            const content = document.getElementById('booking-content');

            try {
                const response = await fetch(`/api/bookings/${id}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    bookingData = await response.json();
                    displayBookingDetails(bookingData);
                    loading.style.display = 'none';
                    content.style.display = 'block';
                } else {
                    throw new Error('Failed to load booking details');
                }
            } catch (error) {
                console.error('Error loading booking details:', error);
                loading.innerHTML = '<i class="fas fa-exclamation-triangle"></i><h3>Lỗi tải dữ liệu</h3><p>Vui lòng thử lại sau.</p>';
            }
        }

        function displayBookingDetails(booking) {
            // Update header
            document.getElementById('booking-id').textContent = booking.id;
            document.getElementById('booking-status').className = `booking-status ${getStatusClass(booking.status)}`;
            document.getElementById('booking-status').textContent = getStatusText(booking.status);

            // Car information
            displayCarInfo(booking);

            // Booking details
            displayBookingInfo(booking);

            // Timeline
            displayTimeline(booking);

            // Charges breakdown
            displayCharges(booking);

            // Contact info
            displayContactInfo(booking);

            // Payout info (for hosts)
            displayPayoutInfo(booking);

            // Actions
            displayActions(booking);
        }

        function displayCarInfo(booking) {
            const carInfo = document.getElementById('car-info');
            const listing = booking.listing;
            const vehicle = listing?.vehicle;

            carInfo.innerHTML = `
                <img src="${vehicle?.imageUrl || 'https://via.placeholder.com/120x80?text=Xe'}" alt="Car" class="car-image">
                <div class="car-details">
                    <h4>${vehicle?.make || 'N/A'} ${vehicle?.model || 'N/A'} ${vehicle?.year || ''}</h4>
                    <p style="color: #6b7280; margin: 4px 0;">
                        <i class="fas fa-map-marker-alt"></i> ${listing?.homeCity || 'N/A'}
                    </p>
                    <p style="color: #6b7280; margin: 4px 0;">
                        <i class="fas fa-gas-pump"></i> ${vehicle?.fuelType || 'N/A'} •
                        <i class="fas fa-cog"></i> ${vehicle?.transmission || 'N/A'} •
                        <i class="fas fa-users"></i> ${vehicle?.seats || 'N/A'} chỗ
                    </p>
                </div>
            `;
        }

        function displayBookingInfo(booking) {
            const startDate = new Date(booking.startAt).toLocaleDateString('vi-VN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const endDate = new Date(booking.endAt).toLocaleDateString('vi-VN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const days = Math.ceil((new Date(booking.endAt) - new Date(booking.startAt)) / (1000 * 60 * 60 * 24));

            document.getElementById('start-date').textContent = startDate;
            document.getElementById('end-date').textContent = endDate;
            document.getElementById('duration').textContent = `${days} ngày`;
            document.getElementById('location').textContent = booking.listing?.homeCity || 'N/A';
        }

        function displayTimeline(booking) {
            const timeline = document.getElementById('timeline');
            const events = generateTimelineEvents(booking);

            timeline.innerHTML = events.map(event => `
                <div class="timeline-item ${event.status}">
                    <div class="timeline-time">${event.time}</div>
                    <div class="timeline-title">${event.title}</div>
                    <div class="timeline-desc">${event.description}</div>
                </div>
            `).join('');
        }

        function generateTimelineEvents(booking) {
            const events = [];
            const status = booking.status;

            // Created
            events.push({
                time: new Date(booking.createdAt).toLocaleString('vi-VN'),
                title: 'Đơn được tạo',
                description: 'Đơn đặt xe đã được tạo thành công',
                status: 'completed'
            });

            // Payment authorized
            if (['PAYMENT_AUTHORIZED', 'IN_PROGRESS', 'COMPLETED'].includes(status)) {
                events.push({
                    time: 'Đã thanh toán',
                    title: 'Thanh toán thành công',
                    description: 'Đã ủy quyền thanh toán cho đơn đặt xe',
                    status: 'completed'
                });
            }

            // Confirmed (for pending bookings)
            if (status === 'INSTANT_CONFIRMED') {
                events.push({
                    time: 'Tự động',
                    title: 'Đơn được xác nhận',
                    description: 'Đơn được xác nhận tự động (instant book)',
                    status: 'completed'
                });
            } else if (['PAYMENT_AUTHORIZED', 'IN_PROGRESS', 'COMPLETED'].includes(status)) {
                events.push({
                    time: 'Đã xác nhận',
                    title: 'Chủ xe duyệt đơn',
                    description: 'Chủ xe đã duyệt đơn đặt xe',
                    status: 'completed'
                });
            } else if (status === 'PENDING_HOST') {
                events.push({
                    time: 'Đang chờ',
                    title: 'Chờ chủ xe duyệt',
                    description: 'Đang chờ chủ xe xác nhận đơn đặt xe',
                    status: 'pending'
                });
            }

            // Check-in
            if (status === 'IN_PROGRESS') {
                events.push({
                    time: 'Đã check-in',
                    title: 'Bắt đầu chuyến đi',
                    description: 'Đã nhận xe và bắt đầu chuyến đi',
                    status: 'active'
                });
            } else if (status === 'COMPLETED') {
                events.push({
                    time: 'Đã check-in',
                    title: 'Bắt đầu chuyến đi',
                    description: 'Đã nhận xe và bắt đầu chuyến đi',
                    status: 'completed'
                });
            }

            // Check-out
            if (status === 'COMPLETED') {
                events.push({
                    time: 'Đã check-out',
                    title: 'Hoàn thành chuyến đi',
                    description: 'Đã trả xe và hoàn thành chuyến đi',
                    status: 'completed'
                });
            }

            // Cancelled
            if (status.startsWith('CANCELLED')) {
                const cancelledBy = status === 'CANCELLED_HOST' ? 'chủ xe' : 'khách hàng';
                events.push({
                    time: 'Đã hủy',
                    title: 'Đơn bị hủy',
                    description: `Đơn đã bị hủy bởi ${cancelledBy}`,
                    status: 'cancelled'
                });
            }

            return events;
        }

        async function displayCharges(booking) {
            const breakdown = document.getElementById('charges-breakdown');

            try {
                // In a real app, you'd fetch charges from API
                // For now, calculate basic breakdown
                const days = Math.ceil((new Date(booking.endAt) - new Date(booking.startAt)) / (1000 * 60 * 60 * 24));
                const basePrice = days * (booking.listing?.price24hCents || 0);
                const platformFee = Math.round(basePrice * 0.1);
                const total = basePrice + platformFee;

                breakdown.innerHTML = `
                    <div class="charge-item">
                        <span class="charge-label">Giá thuê cơ bản (${days} ngày)</span>
                        <span class="charge-amount">${formatCurrency(basePrice)}</span>
                    </div>
                    <div class="charge-item">
                        <span class="charge-label">Phí nền tảng (10%)</span>
                        <span class="charge-amount negative">${formatCurrency(platformFee)}</span>
                    </div>
                    <div class="charge-item">
                        <span class="charge-label">Thuế</span>
                        <span class="charge-amount">0 VND</span>
                    </div>
                    <div class="charge-item">
                        <span class="charge-label"><strong>Tổng cộng</strong></span>
                        <span class="charge-amount positive"><strong>${formatCurrency(total)}</strong></span>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading charges:', error);
                breakdown.innerHTML = '<p>Không thể tải chi tiết thanh toán</p>';
            }
        }

        function displayContactInfo(booking) {
            const contactInfo = document.getElementById('contact-info');
            const guest = booking.guest;
            const host = booking.listing?.vehicle?.owner;

            // Show appropriate contact based on current user role
            // This is a simplified version - in real app, check user role
            contactInfo.innerHTML = `
                <h4>Khách hàng</h4>
                <div class="contact-item">
                    <i class="fas fa-user"></i>
                    <span>${guest?.email || 'N/A'}</span>
                </div>
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <span>${guest?.phone || 'Chưa cập nhật'}</span>
                </div>

                <h4 style="margin-top: 16px;">Chủ xe</h4>
                <div class="contact-item">
                    <i class="fas fa-user"></i>
                    <span>${host?.email || 'N/A'}</span>
                </div>
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <span>${host?.phone || 'Chưa cập nhật'}</span>
                </div>
            `;
        }

        function displayPayoutInfo(booking) {
            // Only show for hosts - simplified check
            const payoutSection = document.getElementById('payout-section');
            const payoutInfo = document.getElementById('payout-info');

            // In real app, check if current user is the host
            const isHost = booking.listing?.vehicle?.owner?.email === getCurrentUserEmail();
            if (!isHost || booking.status !== 'COMPLETED') {
                payoutSection.style.display = 'none';
                return;
            }

            payoutSection.style.display = 'block';

            // Calculate payout
            const days = Math.ceil((new Date(booking.endAt) - new Date(booking.startAt)) / (1000 * 60 * 60 * 24));
            const total = days * (booking.listing?.price24hCents || 0);
            const platformFee = Math.round(total * 0.1);
            const payout = total - platformFee;

            payoutInfo.innerHTML = `
                <h4>Số tiền nhận được</h4>
                <div class="payout-amount">${formatCurrency(payout)} VND</div>
                <p style="margin: 8px 0 0 0; font-size: 14px; color: #065f46;">
                    Đã chuyển vào ví điện tử của bạn
                </p>
            `;
        }

        function displayActions(booking) {
            const actionsSection = document.getElementById('actions-section');
            const actions = getBookingActions(booking);

            actionsSection.innerHTML = actions.map(action => `
                <button class="btn-action ${action.class}" onclick="${action.onclick}">
                    ${action.icon} ${action.text}
                </button>
            `).join('');
        }

        function getBookingActions(booking) {
            const actions = [];
            const status = booking.status;

            // Check if current user is guest or host
            const isGuest = booking.guest?.email === getCurrentUserEmail();
            const isHost = booking.listing?.vehicle?.owner?.email === getCurrentUserEmail();

            if (isGuest) {
                // Guest actions
                switch (status) {
                    case 'PENDING_HOST':
                        actions.push({
                            text: 'Hủy đơn',
                            class: 'btn-danger',
                            icon: '<i class="fas fa-times"></i>',
                            onclick: `cancelBooking(${booking.id})`
                        });
                        break;
                    case 'PAYMENT_AUTHORIZED':
                        actions.push({
                            text: 'Check-in',
                            class: 'btn-success',
                            icon: '<i class="fas fa-sign-in-alt"></i>',
                            onclick: `checkIn(${booking.id})`
                        });
                        actions.push({
                            text: 'Hủy đơn',
                            class: 'btn-danger',
                            icon: '<i class="fas fa-times"></i>',
                            onclick: `cancelBooking(${booking.id})`
                        });
                        break;
                    case 'IN_PROGRESS':
                        actions.push({
                            text: 'Check-out',
                            class: 'btn-primary',
                            icon: '<i class="fas fa-sign-out-alt"></i>',
                            onclick: `checkOut(${booking.id})`
                        });
                        break;
                    case 'COMPLETED':
                        actions.push({
                            text: 'Đánh giá',
                            class: 'btn-secondary',
                            icon: '<i class="fas fa-star"></i>',
                            onclick: `leaveReview(${booking.id})`
                        });
                        break;
                }
            } else if (isHost) {
                // Host actions
                switch (status) {
                    case 'PENDING_HOST':
                        actions.push({
                            text: 'Duyệt đơn',
                            class: 'btn-success',
                            icon: '<i class="fas fa-check"></i>',
                            onclick: `confirmBooking(${booking.id})`
                        });
                        actions.push({
                            text: 'Từ chối',
                            class: 'btn-danger',
                            icon: '<i class="fas fa-times"></i>',
                            onclick: `rejectBooking(${booking.id})`
                        });
                        break;
                    case 'PAYMENT_AUTHORIZED':
                        actions.push({
                            text: 'Check-in',
                            class: 'btn-warning',
                            icon: '<i class="fas fa-sign-in-alt"></i>',
                            onclick: `checkIn(${booking.id})`
                        });
                        actions.push({
                            text: 'Hủy đơn',
                            class: 'btn-danger',
                            icon: '<i class="fas fa-times"></i>',
                            onclick: `cancelBooking(${booking.id}, true)`
                        });
                        break;
                    case 'IN_PROGRESS':
                        actions.push({
                            text: 'Check-out',
                            class: 'btn-primary',
                            icon: '<i class="fas fa-sign-out-alt"></i>',
                            onclick: `checkOut(${booking.id})`
                        });
                        break;
                }
            }

            // Common actions
            actions.push({
                text: 'Quay lại',
                class: 'btn-secondary',
                icon: '<i class="fas fa-arrow-left"></i>',
                onclick: 'history.back()'
            });

            return actions;
        }

        // Action functions
        async function confirmBooking(bookingId) {
            await performBookingAction(bookingId, 'confirm', 'Duyệt đơn đặt xe này?');
        }

        async function rejectBooking(bookingId) {
            await performBookingAction(bookingId, 'reject', 'Từ chối đơn đặt xe này?');
        }

        async function checkIn(bookingId) {
            await performBookingAction(bookingId, 'checkin', 'Xác nhận check-in cho chuyến đi?');
        }

        async function checkOut(bookingId) {
            await performBookingAction(bookingId, 'checkout', 'Xác nhận check-out và hoàn thành chuyến đi?');
        }

        async function cancelBooking(bookingId, isHostCancellation = false) {
            await performBookingAction(bookingId, 'cancel', 'Hủy đơn đặt xe này?', isHostCancellation, true);
        }

        async function performBookingAction(bookingId, action, message, isHostCancellation = false, skipConfirm = false) {
            if (!skipConfirm && !confirm(message)) return;

            showLoading(null, 'Đang xử lý...');

            try {
                const idempotencyKey = generateIdempotencyKey();
                let url = `/bookings/${bookingId}/${action}`;

                if (action === 'cancel') {
                    url += `?isHostCancellation=${isHostCancellation}`;
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Idempotency-Key': idempotencyKey
                    }
                });

                if (response.ok) {
                    showToast('Thao tác thành công!', 'success');
                    // Reload booking details
                    loadBookingDetails(bookingId);
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Thao tác thất bại');
                }
            } catch (error) {
                console.error('Action error:', error);
                showToast(error.message || 'Có lỗi xảy ra', 'error');
            } finally {
                hideLoading();
            }
        }

        function leaveReview(bookingId) {
            alert('Tính năng đánh giá sẽ được thêm sau');
        }

        function getCurrentUserEmail() {
            // In real app, get from authentication context
            // For now, return empty string
            return '';
        }

        function getStatusClass(status) {
            const classes = {
                'PENDING_HOST': 'status-pending_host',
                'INSTANT_CONFIRMED': 'status-instant_confirmed',
                'PAYMENT_AUTHORIZED': 'status-payment_authorized',
                'IN_PROGRESS': 'status-in_progress',
                'COMPLETED': 'status-completed',
                'CANCELLED_GUEST': 'status-cancelled_guest',
                'CANCELLED_HOST': 'status-cancelled_host'
            };
            return classes[status] || 'status-pending_host';
        }

        function getStatusText(status) {
            const texts = {
                'PENDING_HOST': 'Chờ duyệt',
                'INSTANT_CONFIRMED': 'Đã xác nhận',
                'PAYMENT_AUTHORIZED': 'Đã thanh toán',
                'IN_PROGRESS': 'Đang diễn ra',
                'COMPLETED': 'Hoàn thành',
                'CANCELLED_GUEST': 'Đã hủy',
                'CANCELLED_HOST': 'Bị hủy'
            };
            return texts[status] || status;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' VND';
        }

        function generateIdempotencyKey() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Enhanced toast function
        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = `
                <div class="toast ${type}" role="alert">
                    <div class="toast-header">
                        <strong class="me-auto">${type === 'success' ? 'Thành công' : 'Lỗi'}</strong>
                        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast.querySelector('.toast'));
            bsToast.show();

            setTimeout(() => toast.remove(), 5000);
        }
    </script>
</body>
</html>
