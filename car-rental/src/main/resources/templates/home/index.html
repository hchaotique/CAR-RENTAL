<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huy Hoàng Auto 88 - Thuê xe ô tô dễ dàng</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<header th:replace="~{fragments/header :: header}"></header>

<section class="hero">
    <div class="hero-background">
        <!-- Ảnh nền được định nghĩa trong CSS -->
        <div class="hero-overlay"></div>
    </div>
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title">Đừng lãng phí thời gian ở đại lý</h1>
            <p class="hero-subtitle">Thuê chiếc xe bạn muốn, ở bất cứ đâu bạn muốn</p>
            <form class="search-form" th:action="@{/search}" method="get">
                <div class="search-field">
                    <label for="location">Địa điểm</label>
                    <input type="text" id="location" name="location" placeholder="Thành phố, sân bay, địa chỉ hoặc khách sạn" required>
                </div>
                <div class="search-field">
                    <label for="pickupDate">Ngày đi</label>
                    <input type="date" id="pickupDate" name="pickupDate" required>
                </div>
                <div class="search-field">
                    <label for="pickupTime">Giờ đi</label>
                    <input type="time" id="pickupTime" name="pickupTime" required>
                </div>
                <div class="search-field">
                    <label for="returnDate">Ngày về</label>
                    <input type="date" id="returnDate" name="returnDate" required>
                </div>
                <div class="search-field">
                    <label for="returnTime">Giờ về</label>
                    <input type="time" id="returnTime" name="returnTime" required>
                </div>
                <button type="submit" class="search-btn"><i class="fas fa-search"></i> Tìm xe</button>
            </form>
        </div>
    </div>
</section>

<section class="car-section">
    <div class="container">
        <h2 class="section-title">Xe phổ biến</h2>
        <div class="nav-arrows">
            <button class="nav-arrow prev" aria-label="Previous cars"><i class="fas fa-chevron-left"></i></button>
            <button class="nav-arrow next" aria-label="Next cars"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="car-grid" th:if="${listings != null and !listings.isEmpty()}">
            <div th:each="listing : ${listings}" class="car-card" th:attr="data-listing-id=${listing.id}">
                <div class="car-image">
                    <img th:src="${listing.imageUrls != null and not #lists.isEmpty(listing.imageUrls)} ? ${listing.imageUrls[0]} : '/images/default-car.jpg'"
                         alt="Car Image" loading="lazy">
                </div>
                <div class="car-info">
                    <h3 th:text="${listing.title}">Tiêu đề bài đăng</h3>
                    <p th:text="${listing.make + ' ' + listing.model + (listing.year != null ? ' ' + listing.year : '')}">Xe: Make Model Year</p>
                    <p th:text="${listing.homeCity}">Vị trí: Thành phố</p>
                    <div class="rating">
                        <!-- TODO: Thêm rating thực tế -->
                        <span class="stars"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i></span>
                        <span class="reviews">(Chưa có đánh giá)</span>
                    </div>
                    <div class="price">
                        <span class="price-value"
                              th:text="${listing.price24hCents != null ?
                                        (#numbers.formatDecimal(listing.price24hCents * 3, 0, 'COMMA', 0, 'POINT') + '₫ / 3 ngày')
                                        : 'Liên hệ'}">
                            Price for 3 days
                        </span>
                    </div>
                    <button type="button" class="book-btn" th:attr="data-listing-id=${listing.id}" onclick="openBookingModal(this)">Đặt xe</button>
                </div>
            </div>
        </div>
        <div th:if="${listings == null or listings.isEmpty()}" class="no-cars">
            <p>Không có bài đăng nào khả dụng. Hãy thử tìm kiếm.</p>
        </div>
    </div>
</section>

<!-- Các phần khác như Why Choose Us, Become a Host, Testimonials có thể thêm vào đây -->

<footer th:replace="~{fragments/footer :: footer}"></footer>

<!-- Booking Modal -->
<div id="bookingModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Chọn ngày thuê xe</h2>
            <span class="close" onclick="closeBookingModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="bookingForm">
                <input type="hidden" id="selectedCarId" name="listingId">
                <div class="form-group">
                    <label for="modalPickupDate">Ngày nhận xe:</label>
                    <input type="date" id="modalPickupDate" name="pickupDate" required>
                </div>
                <div class="form-group">
                    <label for="modalPickupTime">Giờ nhận xe:</label>
                    <input type="time" id="modalPickupTime" name="pickupTime" value="09:00" required>
                </div>
                <div class="form-group">
                    <label for="modalReturnDate">Ngày trả xe:</label>
                    <input type="date" id="modalReturnDate" name="returnDate" required>
                </div>
                <div class="form-group">
                    <label for="modalReturnTime">Giờ trả xe:</label>
                    <input type="time" id="modalReturnTime" name="returnTime" value="18:00" required>
                </div>
                <button type="button" onclick="proceedToBooking()" class="modal-btn">Tiếp tục đặt xe</button>
            </form>
        </div>
    </div>
</div>

<script th:src="@{/js/script.js}"></script>
<script>
    // Hàm mở modal đặt xe
    function openBookingModal(button) {
        const listingId = button.getAttribute('data-listing-id');
        document.getElementById('selectedCarId').value = listingId;
        document.getElementById('bookingModal').style.display = 'flex'; // Dùng flex để căn giữa
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('modalPickupDate').min = today;
        document.getElementById('modalReturnDate').min = today;

        // Đặt giá trị mặc định cho ngày trả nếu ngày nhận được chọn
        const modalPickupDateInput = document.getElementById('modalPickupDate');
        const modalReturnDateInput = document.getElementById('modalReturnDate');
        modalPickupDateInput.addEventListener('change', function() {
            if (this.value) {
                // Đặt ngày trả là ngày nhận nếu chưa có hoặc nhỏ hơn ngày nhận
                if (!modalReturnDateInput.value || modalReturnDateInput.value < this.value) {
                    modalReturnDateInput.value = this.value;
                }
                modalReturnDateInput.min = this.value; // Ngày trả không được nhỏ hơn ngày nhận
            }
        });
    }

    // Hàm đóng modal đặt xe
    function closeBookingModal() {
        document.getElementById('bookingModal').style.display = 'none';
    }

    // Hàm tiến hành đặt xe
    function proceedToBooking() {
        const id = document.getElementById('selectedCarId').value;
        const pickupDate = document.getElementById('modalPickupDate').value;
        const returnDate = document.getElementById('modalReturnDate').value;
        const pickupTime = document.getElementById('modalPickupTime').value;
        const returnTime = document.getElementById('modalReturnTime').value;

        if (!pickupDate || !returnDate || !pickupTime || !returnTime) {
            alert('Vui lòng chọn đầy đủ ngày và giờ nhận, trả xe.');
            return;
        }

        const button = document.querySelector('.modal-btn');
        button.disabled = true;
        button.textContent = 'Đang xử lý...';

        const url = `/bookings/create?listingId=${id}&pickupDate=${pickupDate}&returnDate=${returnDate}&pickupTime=${pickupTime}&returnTime=${returnTime}`;
        window.location.href = url;
    }

    // Đóng modal khi click ra ngoài
    window.onclick = function (event) {
        const modal = document.getElementById('bookingModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
</script>
</body>
</html>